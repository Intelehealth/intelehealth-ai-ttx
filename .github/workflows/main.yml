name: Build and Deploy Docker Image

on:
  push:
    branches: [ main ]  # Change to your default branch
  workflow_dispatch:  # Allows manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build --no-cache -t ttx:${{ github.sha }} .
        docker tag ttx:${{ github.sha }} ttx:latest
    
    - name: Save Docker image to tar
      run: |
        docker save ttx:latest | gzip > ttx.tar.gz
    
    - name: Transfer image to remote server via SFTP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        source: "ttx.tar.gz"
        target: "/tmp/"
    
    - name: Deploy container on remote server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # Load the Docker image
          gunzip -c /tmp/ttx.tar.gz | docker load
          
          # Stop and remove old container if it exists
          docker stop ttx || true
          docker rm ttx || true
          NETWORK=$(docker inspect medical-ai-api --format='{{range $k,$v := .NetworkSettings.Networks}}{{$k}}{{end}}') 
          # Run the new container
          docker run -d \
            --name ttx \
            --restart unless-stopped \
            --network "$NETWORK" \
             -v /home/ubuntu/deploy/ttx/.env:/app/.env \
            -p 5051:5051 \ 
            ttx:latest
          
          # Clean up the tar file
          rm /tmp/ttx.tar.gz
          
          # Optional: Remove old unused images
          docker image prune -f
